<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIHOéŒå€‰ åˆ©ç”¨çŠ¶æ³åˆ†æ v2 - CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        .content {
            padding: 30px;
        }
        .view-switcher {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .view-button {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        .view-button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        .view-button.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        .chart-container {
            position: relative;
            height: 600px;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 1.1em;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .segment-analysis {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .segment-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .segment-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .segment-heavy { border-left-color: #e74c3c; }
        .segment-regular { border-left-color: #f39c12; }
        .segment-light { border-left-color: #3498db; }
        .segment-trial { border-left-color: #95a5a6; }
        .legend {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .legend-header h3 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 18px;
        }
        .legend-note {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .legend-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
        }
        .legend-item.detailed {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .legend-text {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .legend-text strong {
            color: #333;
            font-size: 15px;
        }
        .legend-criteria {
            color: #0066cc;
            font-size: 13px;
            font-weight: 600;
        }
        .legend-desc {
            color: #666;
            font-size: 12px;
            line-height: 1.3;
        }
        .version-info {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4caf50;
        }
        .github-info {
            background: #f3e5f5;
            color: #7b1fa2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #9c27b0;
        }
        .mobile-info {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
            display: none;
        }
        .csv-upload-section {
            background: #f0f8ff;
            border: 2px dashed #4285f4;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .csv-upload-section h3 {
            margin: 0 0 20px 0;
            color: #1565c0;
            font-size: 20px;
        }
        .upload-area {
            position: relative;
        }
        .csv-input {
            display: none;
        }
        .upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 40px 20px;
            background: white;
            border: 2px dashed #ccc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-label:hover {
            background: #f8f9fa;
            border-color: #4285f4;
        }
        .upload-icon {
            font-size: 48px;
            color: #666;
        }
        .upload-text strong {
            color: #333;
            font-size: 16px;
        }
        .upload-text span {
            color: #666;
            font-size: 14px;
        }
        .upload-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            display: none;
        }
        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .upload-status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        .user-table-section {
            margin-top: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .search-input, .sort-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .search-input {
            flex: 1;
            min-width: 200px;
        }
        .sort-select {
            min-width: 180px;
        }
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .user-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .user-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .user-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
        }
        .user-table tr:hover {
            background: #f5f5f5;
        }
        .segment-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .segment-heavy { background: #e74c3c; }
        .segment-regular { background: #f39c12; }
        .segment-light { background: #3498db; }
        .segment-trial { background: #95a5a6; }
        .segment-definitions {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .segment-definitions h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }
        .definition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .definition-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }
        .definition-text {
            flex: 1;
            font-size: 13px;
            line-height: 1.4;
        }
        .definition-text strong {
            color: #333;
            font-size: 14px;
        }
        .table-summary {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            .chart-container {
                height: 400px;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .view-switcher {
                flex-direction: column;
                align-items: center;
            }
            .mobile-info {
                display: block;
            }
            .table-controls {
                flex-direction: column;
            }
            .search-input, .sort-select {
                width: 100%;
            }
            .user-table {
                font-size: 12px;
            }
            .user-table th, .user-table td {
                padding: 8px 4px;
            }
            .definition-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .definition-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding: 10px;
            }
            .definition-text {
                font-size: 12px;
            }
            .legend-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .legend-item.detailed {
                padding: 10px;
            }
            .legend-text strong {
                font-size: 14px;
            }
            .legend-criteria {
                font-size: 12px;
            }
            .legend-desc {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NIHOéŒå€‰ åˆ©ç”¨çŠ¶æ³åˆ†æ v2</h1>
            <p>CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ - æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ</p>
        </div>
        
        <div class="content">
            <div class="csv-upload-section">
                <h3>ğŸ“„ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <div class="upload-area">
                    <input type="file" id="csvFileInput" accept=".csv" class="csv-input">
                    <label for="csvFileInput" class="upload-label">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">
                            <strong>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</strong><br>
                            <span>CSVãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ*.csvï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</span>
                        </div>
                    </label>
                    <div class="upload-status" id="uploadStatus"></div>
                </div>
            </div>
            
            <div class="view-switcher">
                <button class="view-button active" id="view6months">ğŸ“Š 6ãƒ¶æœˆãƒ“ãƒ¥ãƒ¼</button>
                <button class="view-button" id="view1month">ğŸ“ˆ 7æœˆãƒ“ãƒ¥ãƒ¼</button>
            </div>
            
            <div class="mobile-info" id="mobileInfo">
                ğŸ“± <strong>ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º:</strong> ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€ä¸Šä½100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºã—ã¦ã„ã¾ã™
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="statPeriodLabel">åˆ†ææœŸé–“</h3>
                    <div class="stat-value" id="analysisPeriod">-</div>
                </div>
                <div class="stat-card">
                    <h3 id="statUsersLabel">å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h3>
                    <div class="stat-value" id="activeUsers">-</div>
                </div>
                <div class="stat-card">
                    <h3 id="statFreqLabel">å¹³å‡åˆ©ç”¨é »åº¦</h3>
                    <div class="stat-value" id="avgFrequency">-</div>
                </div>
                <div class="stat-card">
                    <h3 id="statHoursLabel">å¹³å‡åˆ©ç”¨æ™‚é–“</h3>
                    <div class="stat-value" id="avgHours">-</div>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-header">
                    <h3>ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåŸºæº–</h3>
                    <p class="legend-note">æœˆå¹³å‡ã®åˆ©ç”¨é »åº¦ã¨åˆ©ç”¨æ™‚é–“ã§åˆ†é¡</p>
                </div>
                <div class="legend-grid">
                    <div class="legend-item detailed">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <div class="legend-text">
                            <strong>ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼</strong>
                            <span class="legend-criteria">â‰¥10å› ã‹ã¤ â‰¥20æ™‚é–“</span>
                            <span class="legend-desc">ã‚³ã‚¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ¡ã‚¤ãƒ³ã‚¹ãƒšãƒ¼ã‚¹åˆ©ç”¨è€…</span>
                        </div>
                    </div>
                    <div class="legend-item detailed">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <div class="legend-text">
                            <strong>ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼</strong>
                            <span class="legend-criteria">â‰¥5å› ã‹ã¤ â‰¥10æ™‚é–“</span>
                            <span class="legend-desc">å®šæœŸåˆ©ç”¨è€…ãƒ»å®‰å®šã—ãŸåˆ©ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³</span>
                        </div>
                    </div>
                    <div class="legend-item detailed">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <div class="legend-text">
                            <strong>ãƒ©ã‚¤ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼</strong>
                            <span class="legend-criteria">â‰¥2å› ã‹ã¤ â‰¥2æ™‚é–“</span>
                            <span class="legend-desc">è»½åº¦åˆ©ç”¨è€…ãƒ»å‰¯æ¬¡çš„åˆ©ç”¨</span>
                        </div>
                    </div>
                    <div class="legend-item detailed">
                        <div class="legend-color" style="background-color: #95a5a6;"></div>
                        <div class="legend-text">
                            <strong>ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼</strong>
                            <span class="legend-criteria">&lt;2å› ã¾ãŸã¯ &lt;2æ™‚é–“</span>
                            <span class="legend-desc">è©¦ç”¨æ®µéšãƒ»æ–°è¦ãƒ»æ¤œè¨ä¸­ãƒ»ä¼‘çœ ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="usageChart"></canvas>
            </div>
            
            <div class="segment-analysis">
                <h3 id="segmentTitle">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æ</h3>
                <div class="segment-definitions">
                    <h4>ğŸ“Š ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†é¡åŸºæº–</h4>
                    <div class="definition-grid">
                        <div class="definition-item">
                            <span class="segment-badge segment-heavy">ãƒ˜ãƒ“ãƒ¼</span>
                            <div class="definition-text">
                                <strong>æœˆå¹³å‡ â‰¥10å› ã‹ã¤ â‰¥20æ™‚é–“</strong><br>
                                ã‚³ã‚¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ¡ã‚¤ãƒ³ã‚¹ãƒšãƒ¼ã‚¹åˆ©ç”¨è€…
                            </div>
                        </div>
                        <div class="definition-item">
                            <span class="segment-badge segment-regular">ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼</span>
                            <div class="definition-text">
                                <strong>æœˆå¹³å‡ â‰¥5å› ã‹ã¤ â‰¥10æ™‚é–“</strong><br>
                                å®šæœŸåˆ©ç”¨è€…ãƒ»å®‰å®šã—ãŸåˆ©ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³
                            </div>
                        </div>
                        <div class="definition-item">
                            <span class="segment-badge segment-light">ãƒ©ã‚¤ãƒˆ</span>
                            <div class="definition-text">
                                <strong>æœˆå¹³å‡ â‰¥2å› ã‹ã¤ â‰¥2æ™‚é–“</strong><br>
                                è»½åº¦åˆ©ç”¨è€…ãƒ»å‰¯æ¬¡çš„åˆ©ç”¨
                            </div>
                        </div>
                        <div class="definition-item">
                            <span class="segment-badge segment-trial">ãƒˆãƒ©ã‚¤ã‚¢ãƒ«</span>
                            <div class="definition-text">
                                <strong>æœˆå¹³å‡ <2å› ã¾ãŸã¯ <2æ™‚é–“</strong><br>
                                è©¦ç”¨æ®µéšãƒ»æ–°è¦ãƒ»æ¤œè¨ä¸­ãƒ»ä¼‘çœ ãƒ¦ãƒ¼ã‚¶ãƒ¼
                            </div>
                        </div>
                    </div>
                </div>
                <div class="segment-list" id="segmentList"></div>
            </div>
            
            <div class="user-table-section">
                <h3>ğŸ“‹ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3>
                <div class="table-controls">
                    <input type="text" id="userSearch" placeholder="ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§æ¤œç´¢..." class="search-input">
                    <select id="sortSelect" class="sort-select">
                        <option value="name">ãƒ¦ãƒ¼ã‚¶ãƒ¼åé †</option>
                        <option value="6months-freq">6ãƒ¶æœˆåˆ©ç”¨å›æ•°é †</option>
                        <option value="6months-time">6ãƒ¶æœˆåˆ©ç”¨æ™‚é–“é †</option>
                        <option value="7month-freq">7æœˆåˆ©ç”¨å›æ•°é †</option>
                        <option value="7month-time">7æœˆåˆ©ç”¨æ™‚é–“é †</option>
                        <option value="first-date">åˆå›åˆ©ç”¨æ—¥é †</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="userTable" class="user-table">
                        <thead>
                            <tr>
                                <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
                                <th>åˆå›åˆ©ç”¨æ—¥</th>
                                <th>6ãƒ¶æœˆå›æ•°</th>
                                <th>6ãƒ¶æœˆæ™‚é–“</th>
                                <th>7æœˆå›æ•°</th>
                                <th>7æœˆæ™‚é–“</th>
                                <th>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="table-summary" id="tableSummary"></div>
            </div>
        </div>
    </div>

    <script>
        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ - ãƒ‡ãƒ¼ã‚¿ã¯å‹•çš„ã«èª­ã¿è¾¼ã¿
        let EMBEDDED_DATA = [];
        let chart = null;
        let currentView = '6months';
        let userData = [];
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function initializeCSVUpload() {
            const csvInput = document.getElementById('csvFileInput');
            const uploadStatus = document.getElementById('uploadStatus');
            
            csvInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file && file.type === 'text/csv') {
                    handleCSVFile(file);
                } else {
                    showUploadStatus('error', 'âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }
            });
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
            const uploadArea = document.querySelector('.upload-label');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#4285f4';
                this.style.background = '#f0f8ff';
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ccc';
                this.style.background = 'white';
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#ccc';
                this.style.background = 'white';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'text/csv') {
                    csvInput.files = files;
                    handleCSVFile(files[0]);
                } else {
                    showUploadStatus('error', 'âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                }
            });
        }
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleCSVFile(file) {
            showUploadStatus('loading', 'ğŸ“¤ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
            
            Papa.parse(file, {
                header: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    if (results.errors.length > 0) {
                        console.error('CSVè§£æã‚¨ãƒ©ãƒ¼:', results.errors);
                        showUploadStatus('error', 'âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                        return;
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
                    EMBEDDED_DATA = results.data.filter(row => 
                        row.customerName && row.checkinTime && row.stayTime
                    );
                    
                    console.log('ğŸ“Š CSVãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', EMBEDDED_DATA.length, 'ä»¶');
                    showUploadStatus('success', `âœ… ${EMBEDDED_DATA.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    
                    // ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’é–‹å§‹
                    initializeApp();
                },
                error: function(error) {
                    console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showUploadStatus('error', 'âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            });
        }
        
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³è¡¨ç¤º
        function showUploadStatus(type, message) {
            const status = document.getElementById('uploadStatus');
            status.className = `upload-status ${type}`;
            status.textContent = message;
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç‰ˆ: åˆæœŸåŒ–é–‹å§‹');
            
            // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            initializeCSVUpload();
            
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
            if (EMBEDDED_DATA.length > 0) {
                console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿:', EMBEDDED_DATA.length, 'è¡Œ');
                initializeApp();
            } else {
                console.log('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                // åˆæœŸçŠ¶æ…‹ã§ã®è¡¨ç¤ºæ›´æ–°
                updateInitialState();
            }
        });
        
        // åˆæœŸçŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
        function updateInitialState() {
            document.getElementById('analysisPeriod').textContent = '-';
            document.getElementById('activeUsers').textContent = '-';
            document.getElementById('avgFrequency').textContent = '-';
            document.getElementById('avgHours').textContent = '-';
            
            // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã«æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            const chartContainer = document.querySelector('.chart-container');
            chartContainer.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #666;">
                    <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æã®æº–å‚™å®Œäº†</h3>
                    <p>ä¸Šè¨˜ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€<br>è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãŒåˆ†æãƒ»è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                </div>
            `;
        }
        
        // åˆæœŸåŒ–é–¢æ•°
        function initializeApp() {
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹');
            
            // ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            document.getElementById('view6months').addEventListener('click', () => switchView('6months'));
            document.getElementById('view1month').addEventListener('click', () => switchView('1month'));
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿å‡¦ç†
            processData();
        }
        
        // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function switchView(view) {
            console.log('ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ:', view);
            currentView = view;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.view-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view' + view).classList.add('active');
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’å†å‡¦ç†
            processData();
        }
        
        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
        function processData() {
            console.log(currentView + 'ãƒ“ãƒ¥ãƒ¼ã§ãƒ‡ãƒ¼ã‚¿å‡¦ç†é–‹å§‹...');
            
            if (!EMBEDDED_DATA || EMBEDDED_DATA.length === 0) {
                console.error('ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                return;
            }
            
            const rawData = EMBEDDED_DATA;
            console.log('ç”Ÿãƒ‡ãƒ¼ã‚¿è¡Œæ•°:', rawData.length);
            
            // ç¾åœ¨ã®æ—¥ä»˜ã‚’åŸºæº–ã«æœŸé–“ã‚’è¨ˆç®—
            let now = new Date();
            let periodStart = new Date(now);
            
            if (currentView === '6months') {
                periodStart.setMonth(now.getMonth() - 6);
            } else {
                // 1ãƒ¶æœˆãƒ“ãƒ¥ãƒ¼ã¯7æœˆã«é™å®š
                periodStart = new Date(2025, 6, 1); // 2025å¹´7æœˆ1æ—¥
                now = new Date(2025, 6, 31, 23, 59, 59); // 2025å¹´7æœˆ31æ—¥ 23:59:59
            }
            
            console.log('åˆ†ææœŸé–“:', periodStart.toLocaleDateString(), 'ã€œ', now.toLocaleDateString());
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
            const userStats = {};
            
            rawData.forEach(row => {
                // Safariå¯¾å¿œ: æ—¥ä»˜æ–‡å­—åˆ—ã‚’æ¨™æº–å½¢å¼ã«å¤‰æ›
                let checkinDateStr = row.checkinTime;
                if (checkinDateStr && typeof checkinDateStr === 'string') {
                    // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’å‰Šé™¤ "2025-07-30 13:16:13 +0900" â†’ "2025-07-30 13:16:13"
                    checkinDateStr = checkinDateStr.replace(/\s+[+-]\d{4}$/, '');
                    // ã‚¹ãƒšãƒ¼ã‚¹ã‚’Tã«å¤‰æ› "2025-07-30 13:16:13" â†’ "2025-07-30T13:16:13"
                    checkinDateStr = checkinDateStr.replace(/\s+/, 'T');
                    
                    // å¤ã„å½¢å¼ã‚‚å¯¾å¿œ "2024/7/15 14:30" â†’ "2024-07-15T14:30:00"
                    checkinDateStr = checkinDateStr.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})T(\d{1,2}):(\d{2})/, function(match, year, month, day, hour, minute) {
                        const mm = month.padStart(2, '0');
                        const dd = day.padStart(2, '0');
                        const hh = hour.padStart(2, '0');
                        return `${year}-${mm}-${dd}T${hh}:${minute}:00`;
                    });
                }
                
                const checkinDate = new Date(checkinDateStr);
                const stayTime = parseStayTime(row.stayTime);
                
                if (isNaN(checkinDate.getTime()) || stayTime === null) return;
                if (checkinDate < periodStart || checkinDate > now) return;
                
                const userName = row.customerName;
                
                if (!userStats[userName]) {
                    userStats[userName] = {
                        name: userName,
                        visits: 0,
                        totalHours: 0
                    };
                }
                
                userStats[userName].visits++;
                userStats[userName].totalHours += stayTime;
            });
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿é…åˆ—ã«å¤‰æ›
            userData = Object.values(userStats).map(user => ({
                ...user,
                avgFrequency: currentView === '6months' ? user.visits / 6 : user.visits,
                avgTime: currentView === '6months' ? user.totalHours / 6 : user.totalHours
            }));
            
            console.log('å‡¦ç†æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°:', userData.length);
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            updateStats();
            
            // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
            updateChart();
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†æã‚’æ›´æ–°
            updateSegmentAnalysis();
            
            // ãƒ¢ãƒã‚¤ãƒ«æƒ…å ±ã®è¡¨ç¤ºåˆ¶å¾¡
            updateMobileInfo();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
            updateUserTable();
        }
        
        // ãƒ¢ãƒã‚¤ãƒ«æƒ…å ±è¡¨ç¤ºåˆ¶å¾¡
        function updateMobileInfo() {
            const mobileInfo = document.getElementById('mobileInfo');
            const isMobile = window.innerWidth < 768;
            const isDataLimited = isMobile && userData.length > 100;
            
            if (isDataLimited) {
                mobileInfo.style.display = 'block';
                mobileInfo.innerHTML = `ğŸ“± <strong>ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º:</strong> ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€ä¸Šä½100ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå…¨${userData.length}ä»¶ä¸­ï¼‰ã‚’è¡¨ç¤º`;
            } else {
                mobileInfo.style.display = 'none';
            }
        }
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', function() {
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(function() {
                console.log('ğŸ”„ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚º:', window.innerWidth);
                updateMobileInfo();
                if (chart) {
                    updateChart();
                }
            }, 250);
        });
        
        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            const totalUsers = userData.length;
            const avgFreq = userData.reduce((sum, user) => sum + user.avgFrequency, 0) / totalUsers;
            const avgTime = userData.reduce((sum, user) => sum + user.avgTime, 0) / totalUsers;
            
            const periodLabel = currentView === '6months' ? 'ç›´è¿‘6ãƒ¶æœˆ' : '2025å¹´7æœˆ';
            const freqLabel = currentView === '6months' ? 'æœˆå¹³å‡åˆ©ç”¨å›æ•°' : '7æœˆåˆ©ç”¨å›æ•°';
            const timeLabel = currentView === '6months' ? 'æœˆå¹³å‡åˆ©ç”¨æ™‚é–“' : '7æœˆåˆ©ç”¨æ™‚é–“';
            
            document.getElementById('analysisPeriod').textContent = periodLabel;
            document.getElementById('activeUsers').textContent = totalUsers + 'äºº';
            document.getElementById('avgFrequency').textContent = avgFreq.toFixed(1) + 'å›';
            document.getElementById('avgHours').textContent = avgTime.toFixed(1) + 'h';
            
            document.getElementById('statFreqLabel').textContent = freqLabel;
            document.getElementById('statHoursLabel').textContent = timeLabel;
        }
        
        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateChart() {
            console.log('ğŸ“Š ã‚°ãƒ©ãƒ•æ›´æ–°é–‹å§‹ - ãƒ‡ãƒã‚¤ã‚¹å¹…:', window.innerWidth);
            const ctx = document.getElementById('usageChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿é‡ã‚’åˆ¶é™
            const isMobile = window.innerWidth < 768;
            let processedData = userData;
            
            if (isMobile && userData.length > 100) {
                // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸Šä½100ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º
                processedData = userData
                    .sort((a, b) => (b.avgFrequency + b.avgTime) - (a.avgFrequency + a.avgTime))
                    .slice(0, 100);
                console.log('ğŸ“± ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿åˆ¶é™:', processedData.length, 'ä»¶');
            }
            
            const chartData = processedData.map(user => ({
                x: user.avgFrequency,
                y: user.avgTime,
                label: user.name
            }));
            
            console.log('ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™å®Œäº†:', chartData.length, 'ä»¶');
            
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                        data: chartData,
                        backgroundColor: chartData.map(user => getSegmentColor(user.x, user.y)),
                        borderColor: chartData.map(user => getSegmentColor(user.x, user.y)),
                        pointRadius: function(context) {
                            // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã
                            return window.innerWidth < 768 ? 4 : 8;
                        },
                        pointHoverRadius: function(context) {
                            return window.innerWidth < 768 ? 8 : 12;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: window.innerWidth < 768 ? 'nearest' : 'point'
                    },
                    elements: {
                        point: {
                            hitRadius: window.innerWidth < 768 ? 15 : 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: currentView === '6months' ? 
                                'æœˆå¹³å‡åˆ©ç”¨é »åº¦ vs æœˆå¹³å‡åˆ©ç”¨æ™‚é–“ï¼ˆç›´è¿‘6ãƒ¶æœˆï¼‰' : 
                                'åˆ©ç”¨é »åº¦ vs åˆ©ç”¨æ™‚é–“ï¼ˆ2025å¹´7æœˆï¼‰'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const user = context.raw;
                                    return user.label + ': ' + 
                                           user.x.toFixed(1) + 'å›, ' + 
                                           user.y.toFixed(1) + 'æ™‚é–“';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: currentView === '6months' ? 'æœˆå¹³å‡åˆ©ç”¨é »åº¦ï¼ˆå›ï¼‰' : '7æœˆåˆ©ç”¨é »åº¦ï¼ˆå›ï¼‰'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: currentView === '6months' ? 'æœˆå¹³å‡åˆ©ç”¨æ™‚é–“ï¼ˆæ™‚é–“ï¼‰' : '7æœˆåˆ©ç”¨æ™‚é–“ï¼ˆæ™‚é–“ï¼‰'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const user = userData[index];
                            alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼: ' + user.name + '\nåˆ©ç”¨é »åº¦: ' + user.avgFrequency.toFixed(1) + 'å›\nåˆ©ç”¨æ™‚é–“: ' + user.avgTime.toFixed(1) + 'æ™‚é–“');
                        }
                    }
                }
            });
        }
        
        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†ææ›´æ–°
        function updateSegmentAnalysis() {
            const segments = {
                heavy: [],
                regular: [],
                light: [],
                trial: []
            };
            
            userData.forEach(user => {
                const segment = determineSegment(user.avgFrequency, user.avgTime);
                segments[segment].push(user);
            });
            
            const segmentList = document.getElementById('segmentList');
            segmentList.innerHTML = '';
            
            const segmentLabels = {
                heavy: 'ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                regular: 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼', 
                light: 'ãƒ©ã‚¤ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                trial: 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«ãƒ¦ãƒ¼ã‚¶ãƒ¼'
            };
            
            Object.entries(segments).forEach(([key, users]) => {
                const div = document.createElement('div');
                div.className = 'segment-item segment-' + key;
                div.innerHTML = '<h4>' + segmentLabels[key] + ' (' + users.length + 'äºº)</h4>' +
                               '<p>' + users.slice(0, 5).map(u => u.name).join(', ') + 
                               (users.length > 5 ? ' ä»–' + (users.length - 5) + 'äºº' : '') + '</p>';
                segmentList.appendChild(div);
            });
        }
        
        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¤å®š
        function determineSegment(frequency, time) {
            if (frequency >= 10 && time >= 20) return 'heavy';
            if (frequency >= 5 && time >= 10) return 'regular';
            if (frequency >= 2 && time >= 2) return 'light';
            return 'trial';
        }
        
        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè‰²å–å¾—
        function getSegmentColor(frequency, time) {
            const segment = determineSegment(frequency, time);
            const colors = {
                heavy: '#e74c3c',
                regular: '#f39c12',
                light: '#3498db',
                trial: '#95a5a6'
            };
            return colors[segment];
        }
        
        // æ»åœ¨æ™‚é–“è§£æ
        function parseStayTime(timeStr) {
            if (!timeStr) return null;
            
            const match = timeStr.match(/^(\d{1,2}):(\d{2}):(\d{2})$/);
            if (!match) return null;
            
            const hours = parseInt(match[1]);
            const minutes = parseInt(match[2]);
            const seconds = parseInt(match[3]);
            
            return hours + (minutes / 60) + (seconds / 3600);
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£ã®å¤‰æ•°
        let allUserData = [];
        let filteredUserData = [];
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        function updateUserTable() {
            console.log('ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°é–‹å§‹');
            
            // è©³ç´°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—
            allUserData = calculateDetailedUserData();
            filteredUserData = [...allUserData];
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
            renderUserTable();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupTableEventListeners();
            
            console.log('ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°å®Œäº†:', allUserData.length, 'ä»¶');
        }
        
        // è©³ç´°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿è¨ˆç®—
        function calculateDetailedUserData() {
            const userStats = {};
            
            // 6ãƒ¶æœˆã¨7æœˆã®æœŸé–“ã‚’è¨­å®š
            const now = new Date();
            const sixMonthsAgo = new Date(now);
            sixMonthsAgo.setMonth(now.getMonth() - 6);
            
            const julyStart = new Date(2025, 6, 1);
            const julyEnd = new Date(2025, 6, 31, 23, 59, 59);
            
            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†
            EMBEDDED_DATA.forEach(row => {
                // Safariå¯¾å¿œ: æ—¥ä»˜æ–‡å­—åˆ—ã‚’æ¨™æº–å½¢å¼ã«å¤‰æ›
                let checkinDateStr = row.checkinTime;
                if (checkinDateStr && typeof checkinDateStr === 'string') {
                    // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ã‚’å‰Šé™¤ "2025-07-30 13:16:13 +0900" â†’ "2025-07-30 13:16:13"
                    checkinDateStr = checkinDateStr.replace(/\s+[+-]\d{4}$/, '');
                    // ã‚¹ãƒšãƒ¼ã‚¹ã‚’Tã«å¤‰æ› "2025-07-30 13:16:13" â†’ "2025-07-30T13:16:13"
                    checkinDateStr = checkinDateStr.replace(/\s+/, 'T');
                    
                    // å¤ã„å½¢å¼ã‚‚å¯¾å¿œ "2024/7/15 14:30" â†’ "2024-07-15T14:30:00"
                    checkinDateStr = checkinDateStr.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})T(\d{1,2}):(\d{2})/, function(match, year, month, day, hour, minute) {
                        const mm = month.padStart(2, '0');
                        const dd = day.padStart(2, '0');
                        const hh = hour.padStart(2, '0');
                        return `${year}-${mm}-${dd}T${hh}:${minute}:00`;
                    });
                }
                
                const checkinDate = new Date(checkinDateStr);
                const stayTime = parseStayTime(row.stayTime);
                
                console.log('ğŸ” ãƒ‡ãƒ¼ã‚¿å‡¦ç†:', row.customerName, checkinDateStr, checkinDate, stayTime);
                
                if (isNaN(checkinDate.getTime()) || stayTime === null) {
                    console.log('âŒ ã‚¹ã‚­ãƒƒãƒ—:', row.customerName, 'Date:', checkinDate, 'Time:', stayTime);
                    return;
                }
                
                const userName = row.customerName;
                
                if (!userStats[userName]) {
                    userStats[userName] = {
                        name: userName,
                        firstDate: checkinDate,
                        sixMonth: { visits: 0, hours: 0 },
                        july: { visits: 0, hours: 0 }
                    };
                }
                
                // åˆå›åˆ©ç”¨æ—¥ã‚’æ›´æ–°
                if (checkinDate < userStats[userName].firstDate) {
                    userStats[userName].firstDate = checkinDate;
                }
                
                // 6ãƒ¶æœˆãƒ‡ãƒ¼ã‚¿
                if (checkinDate >= sixMonthsAgo) {
                    userStats[userName].sixMonth.visits++;
                    userStats[userName].sixMonth.hours += stayTime;
                }
                
                // 7æœˆãƒ‡ãƒ¼ã‚¿
                if (checkinDate >= julyStart && checkinDate <= julyEnd) {
                    userStats[userName].july.visits++;
                    userStats[userName].july.hours += stayTime;
                }
            });
            
            // é…åˆ—ã«å¤‰æ›ã—ã¦ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            return Object.values(userStats).map(user => ({
                ...user,
                sixMonthAvgFreq: user.sixMonth.visits / 6,
                sixMonthAvgTime: user.sixMonth.hours / 6,
                segment: determineSegment(user.sixMonth.visits / 6, user.sixMonth.hours / 6)
            }));
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderUserTable() {
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = '';
            
            filteredUserData.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${user.name}</strong></td>
                    <td>${user.firstDate.toLocaleDateString('ja-JP')}</td>
                    <td>${user.sixMonth.visits}å›</td>
                    <td>${user.sixMonth.hours.toFixed(1)}h</td>
                    <td>${user.july.visits}å›</td>
                    <td>${user.july.hours.toFixed(1)}h</td>
                    <td><span class="segment-badge segment-${user.segment}">${getSegmentLabel(user.segment)}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
            updateTableSummary();
        }
        
        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ©ãƒ™ãƒ«å–å¾—
        function getSegmentLabel(segment) {
            const labels = {
                heavy: 'ãƒ˜ãƒ“ãƒ¼',
                regular: 'ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼',
                light: 'ãƒ©ã‚¤ãƒˆ',
                trial: 'ãƒˆãƒ©ã‚¤ã‚¢ãƒ«'
            };
            return labels[segment] || 'ãã®ä»–';
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µãƒãƒªãƒ¼æ›´æ–°
        function updateTableSummary() {
            const summary = document.getElementById('tableSummary');
            const total = filteredUserData.length;
            const totalAll = allUserData.length;
            
            const segmentCounts = {
                heavy: filteredUserData.filter(u => u.segment === 'heavy').length,
                regular: filteredUserData.filter(u => u.segment === 'regular').length,
                light: filteredUserData.filter(u => u.segment === 'light').length,
                trial: filteredUserData.filter(u => u.segment === 'trial').length
            };
            
            summary.innerHTML = `
                <strong>è¡¨ç¤ºä¸­:</strong> ${total}/${totalAll} ãƒ¦ãƒ¼ã‚¶ãƒ¼ | 
                <span style="color: #e74c3c;">â—</span> ãƒ˜ãƒ“ãƒ¼: ${segmentCounts.heavy}äºº | 
                <span style="color: #f39c12;">â—</span> ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼: ${segmentCounts.regular}äºº | 
                <span style="color: #3498db;">â—</span> ãƒ©ã‚¤ãƒˆ: ${segmentCounts.light}äºº | 
                <span style="color: #95a5a6;">â—</span> ãƒˆãƒ©ã‚¤ã‚¢ãƒ«: ${segmentCounts.trial}äºº
            `;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupTableEventListeners() {
            // æ¤œç´¢æ©Ÿèƒ½
            const searchInput = document.getElementById('userSearch');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filteredUserData = allUserData.filter(user => 
                    user.name.toLowerCase().includes(searchTerm)
                );
                renderUserTable();
            });
            
            // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
            const sortSelect = document.getElementById('sortSelect');
            sortSelect.addEventListener('change', function() {
                const sortKey = this.value;
                sortUserData(sortKey);
                renderUserTable();
            });
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ãƒˆ
        function sortUserData(sortKey) {
            switch (sortKey) {
                case 'name':
                    filteredUserData.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                    break;
                case '6months-freq':
                    filteredUserData.sort((a, b) => b.sixMonth.visits - a.sixMonth.visits);
                    break;
                case '6months-time':
                    filteredUserData.sort((a, b) => b.sixMonth.hours - a.sixMonth.hours);
                    break;
                case '7month-freq':
                    filteredUserData.sort((a, b) => b.july.visits - a.july.visits);
                    break;
                case '7month-time':
                    filteredUserData.sort((a, b) => b.july.hours - a.july.hours);
                    break;
                case 'first-date':
                    filteredUserData.sort((a, b) => a.firstDate - b.firstDate);
                    break;
            }
        }
        
        console.log('GitHub Pagesç‰ˆï¼ˆæ›´æ–°ï¼‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
    </script>
</body>
</html>